{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/python-amazon-keyspaces-cassandra/","result":{"pageContext":{"id":"6571d93411863a3420acc692","node":{"id":"6571d93411863a3420acc692","slug":"python-amazon-keyspaces-cassandra","url":"https://xprilion.com/python-amazon-keyspaces-cassandra","title":"Working with Amazon Keyspaces Cassandra distribution using Python","featured":false,"subtitle":null,"brief":"Cassandra is a popular NoSQL database with capabilities to handle massive data by using a distributed array of commodity hardware. After a boring introduction, here's the fun part - Cassandra is a Facebook contribution to the world of Open Source, ha...","coverImage":{"url":"https://cdn.hashnode.com/res/hashnode/image/upload/v1701959885282/69e22132-ac0b-4689-8725-06cfd9f31102.png"},"content":{"html":"<p><a target=\"_blank\" href=\"https://cassandra.apache.org/doc/latest/\">Cassandra</a> is a popular NoSQL database with capabilities to handle massive data by using a distributed array of commodity hardware. After a boring introduction, here's the fun part - Cassandra is a Facebook contribution to the world of Open Source, having been developed to handle the inbox search feature in Facebook almost a decade ago, and since it has been handed over to the <a target=\"_blank\" href=\"https://www.apache.org/\">Apache Software Foundation</a>, it has been among the top open source projects under the organization.</p>\n<p>Cassandra powers the highly intensive queries in the applications of several major tech players - Instagram, Netflix, Facebook (before replacing it with HBase and further HBase with MyRocks), Twitter (before replacing it with in-house Manhattan), Walmart Labs, CERN, Cisco WebEx, and many more. You can read an extensive praise-o-logy of Cassandra on this <a target=\"_blank\" href=\"https://ubuntu.com/blog/apache-cassandra-top-benefits\">Ubuntu blog titled What is Cassandra and why are big tech companies using it?</a></p>\n<p>While it can be a hassle to install and maintain a Cassandra database server online, <a target=\"_blank\" href=\"https://aws.amazon.com/keyspaces/\">Amazon Keyspaces</a> offering by Amazon Web Services makes it a no-brainer to use. A similar powerful offering is provided by Datastax by the name <a target=\"_blank\" href=\"https://www.datastax.com/products/datastax-astra\">Astra</a>. Both provide a managed service for Cassandra database which you can readily use both for development and production needs. Big plus - you can try both for free!</p>\n<p>In this tutorial, I shall be moving ahead with Amazon Keyspaces, considering the dearth of a complete example of how to use it on the Internet. You can very easily modify it to work with Datastax Astra.</p>\n<p>First off, before we make any queries, head over to the <a target=\"_blank\" href=\"https://console.aws.amazon.com/keyspaces/home\">Amazon Keyspaces dashboard</a> and create a Keyspace and a sample Table using the Dashboard or the CQL Editor. Both actions being fairly simple, I shall leave it up to you to <a target=\"_blank\" href=\"https://docs.aws.amazon.com/keyspaces/latest/devguide/getting-started.ddl.html\">explore how to get it done</a>. Let's move ahead with how you can use them with a Python application.</p>\n<p>For convenience, I shall assume that the keyspace you created is named <code>test_keyspace</code> and the table is named <code>users</code>. The definition for <code>users</code> table is expected to be -</p>\n<div class=\"hn-table\">\n<table>\n<thead>\n<tr>\n<td>Column</td><td>Type</td></tr>\n</thead>\n<tbody>\n<tr>\n<td>id</td><td>uuid</td></tr>\n<tr>\n<td>name</td><td>varchar</td></tr>\n<tr>\n<td>age</td><td>integer</td></tr>\n<tr>\n<td>city</td><td>varchar</td></tr>\n</tbody>\n</table>\n</div><p>You'll need to download a <a target=\"_blank\" href=\"https://www.comodo.com/resources/small-business/digital-certificates.php\">Digital Certificate</a> provided by Amazon to be able to connect to Keyspaces since the service only connects through TLS. To do so, use the following command in a terminal window -</p>\n<pre><code class=\"lang-bash\">curl https://www.amazontrust.com/repository/AmazonRootCA1.pem -O\n</code></pre>\n<p>Create a new folder in your working directory named <code>.cassandra</code> and move the <code>AmazonRootCA1.pem</code> file there. Just cleaning up the working space, tbh, you can keep it wherever you wish, as long as its accessible to your Python script.</p>\n<p>Next, we shall need the <code>cassandra-driver</code> library for quick functionality to use Cassandra with Python. Run the following command to install it -</p>\n<pre><code class=\"lang-bash\">pip install cassandra-driver\n</code></pre>\n<p>Now, we shall write a small barebones wrapper object for our connection with Amazon Keyspaces. Create a file called <a target=\"_blank\" href=\"http://db.py\"><code>db.py</code></a> in your working directory.</p>\n<p>Add the following code to make all necessary imports -</p>\n<pre><code class=\"lang-python\"><span class=\"hljs-keyword\">from</span> cassandra.auth <span class=\"hljs-keyword\">import</span> PlainTextAuthProvider\n<span class=\"hljs-keyword\">from</span> cassandra.cluster <span class=\"hljs-keyword\">import</span> Cluster\n<span class=\"hljs-keyword\">from</span> ssl <span class=\"hljs-keyword\">import</span> SSLContext, PROTOCOL_TLSv1_2, CERT_REQUIRED\n<span class=\"hljs-keyword\">from</span> cassandra <span class=\"hljs-keyword\">import</span> ConsistencyLevel\n<span class=\"hljs-keyword\">from</span> cassandra.query <span class=\"hljs-keyword\">import</span> SimpleStatement\n</code></pre>\n<p>The above imports indicate a few things -</p>\n<ul>\n<li><ol>\n<li>We're going to be using the <code>PlainTextAuthProvider</code> which means at some point we'll need a username and password combination for our connection with the database. We shall come around this.</li>\n</ol>\n</li>\n<li><ol>\n<li><code>Cluster</code> indicates that we shall be creating an object of the Cassandra Cluster we connect to. This provides cluster level operations which can be useful for you, but not much in the course of this tutorial.</li>\n</ol>\n</li>\n<li><ol>\n<li><code>SSLContext, PROTOCOL_TLSv1_2, CERT_REQUIRED</code> are all required for making a TLS connection to the Amazon Keyspaces service.</li>\n</ol>\n</li>\n<li><ol>\n<li><code>ConsistencyLevel</code> if this is a bouncer, we shall get to overcoming it further down in this tutorial.</li>\n</ol>\n</li>\n<li><ol>\n<li><code>SimpleStatement</code> is a simple CSQL statement, no wonders here.</li>\n</ol>\n</li>\n</ul>\n<p>Next, let's begin using these imports.</p>\n<p>Create a class <code>Cassandra</code> and add an initialization constructor which creates and connection to the database service -</p>\n<pre><code class=\"lang-python\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Cassandra</span>:</span>\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">def</span> <span class=\"hljs-title\">__init__</span>(<span class=\"hljs-params\">self</span>):</span>\n        ssl_context = SSLContext(PROTOCOL_TLSv1_2)\n        ssl_context.load_verify_locations(<span class=\"hljs-string\">'.cassandra/AmazonRootCA1.pem'</span>)\n        ssl_context.verify_mode = CERT_REQUIRED\n        auth_provider = PlainTextAuthProvider(\n            username=<span class=\"hljs-string\">'ServiceUsername'</span>,\n            password=<span class=\"hljs-string\">'ServicePassword'</span>)\n        self.cluster = Cluster(\n            [<span class=\"hljs-string\">'cassandra.us-east-1.amazonaws.com'</span>],\n            ssl_context=ssl_context,\n            auth_provider=auth_provider,\n            port=<span class=\"hljs-number\">9142</span>)\n        self.session = self.cluster.connect(<span class=\"hljs-string\">\"test_keyspace\"</span>)\n</code></pre>\n<p>Notice <code>ServiceUsername</code> and <code>ServicePassword</code>, you do not yet have them. To create a pair of credentials to use, follow this instructions in <a target=\"_blank\" href=\"https://docs.aws.amazon.com/keyspaces/latest/devguide/programmatic.credentials.html#programmatic.credentials.ssc\">this tutorial</a>.</p>\n<p>Your Cluster endpoint (<a target=\"_blank\" href=\"http://cassandra.us-east-1.amazonaws.com\"><code>cassandra.us-east-1.amazonaws.com</code></a>) could differ from the one I have used in my example. You can find out your endpoint by visiting <a target=\"_blank\" href=\"https://docs.aws.amazon.com/keyspaces/latest/devguide/programmatic.endpoints.html\">this list</a> and use the endpoint corresponding to your AWS Region.</p>\n<p>Now, let's create a method for the <code>Cassandra</code> class that we can use to execute queries -</p>\n<pre><code class=\"lang-python\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Cassandra</span>:</span>\n    ...\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">def</span> <span class=\"hljs-title\">execute</span>(<span class=\"hljs-params\">self, query</span>):</span>\n            <span class=\"hljs-keyword\">return</span> self.session.execute(SimpleStatement(\n                query, consistency_level=ConsistencyLevel.LOCAL_QUORUM))\n</code></pre>\n<p>Look, we used the <code>ConsistencyLevel</code> object here! What is this bird?</p>\n<p><img src=\"https://cdn.hashnode.com/res/hashnode/image/upload/v1701959976438/66abf0eb-5036-4fdf-86c2-3ec3467876db.jpeg\" alt class=\"image--center mx-auto\" /></p>\n<p><strong>Consistency Level</strong> is the number of nodes which need to confirm that a particular write operation into a Cassandra database is successful. In simpler words, since Cassandra is a distributed database, and the data stored in Cassandra is split over multiple nodes, a single write operation is successful only when maximum possible nodes acknowledge the write operation as valid. For this, we use different consistency levels, some of which are - <code>LOCAL_ONE</code>, <code>LOCAL_QUORUM</code>, <code>ALL</code>, etc. You can read more about consistency levels in <a target=\"_blank\" href=\"https://www.geeksforgeeks.org/consistency-levels-in-cassandra/\">this blog by Ashish Rana on GeeksforGeeks</a>.</p>\n<p>Currently, Amazon Keyspaces works only with the <code>LOCAL_QUORUM</code> consistency level.</p>\n<p>Now, we can delve into some action!</p>\n<p>Create a new file called <a target=\"_blank\" href=\"http://main.py\"><code>main.py</code></a> (or whatever fancy wording you can think of in 1 second), and put the following lines in it to try inserting a new entry to the database -</p>\n<pre><code class=\"lang-python\"><span class=\"hljs-keyword\">from</span> db <span class=\"hljs-keyword\">import</span> Cassandra\n\ncsql = Cassandra()\n\n<span class=\"hljs-comment\"># Insert Query</span>\nresults = csql.execute(<span class=\"hljs-string\">\"INSERT INTO users (id, name, age, city) \\\n                        VALUES (6ab09bec-e68e-48d9-a5f8-97e6fb4c9b47, \\\n                       'John', 24, 'Delhi')\"</span>)\n</code></pre>\n<p>Now, save the file and try executing it from the terminal using the following command -</p>\n<pre><code class=\"lang-bash\">python main.py\n</code></pre>\n<p>If the query is successful, you shall see no errors.</p>\n<p>Let's try reading the database and see if we've got the entry right. Comment out the Insert query code in the <a target=\"_blank\" href=\"http://main.py\"><code>main.py</code></a> file and add the following lines -</p>\n<pre><code class=\"lang-python\"><span class=\"hljs-comment\"># Read query</span>\nresults = csql.execute(<span class=\"hljs-string\">\"SELECT * FROM users\"</span>)\nprint([x <span class=\"hljs-keyword\">for</span> x <span class=\"hljs-keyword\">in</span> results])\n</code></pre>\n<p>You should see the output similar to this -</p>\n<pre><code class=\"lang-text\">[Row(id=UUID('6ab09bec-e68e-48d9-a5f8-97e6fb4c9b47'), city='Delhi', age=24, name='John')]\n</code></pre>\n<p>If not, you need to observe the error message and try fixing the code! You can find the full code for this tutorial at - <a target=\"_blank\" href=\"https://github.com/xprilion/python-amazon-keyspaces\">https://github.com/xprilion/python-amazon-keyspaces</a></p>\n<p>Cassandra can be a great tool if you're looking to build highly scalable and mission-critical applications (given you need something like Cassandra, at all) and Amazon Keyspaces makes it very simple and efficient to use and manage.</p>\n<p>It is possible to use Amazon Keyspaces with other backends as well, and I shall leave it for you to explore them at your interest.</p>\n<p>Thanks for reading this!</p>\n"},"publishedAt":"2020-09-17T06:30:00.000Z","seo":{"title":"100009","description":null},"tags":[{"slug":"blog"}]}}},"staticQueryHashes":[],"slicesMap":{}}