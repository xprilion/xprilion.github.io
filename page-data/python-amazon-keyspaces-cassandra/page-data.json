{"componentChunkName":"component---src-templates-blog-post-js","path":"/python-amazon-keyspaces-cassandra/","result":{"data":{"site":{"siteMetadata":{"title":"xprilion's blog","author":"Anubhav Singh","siteUrl":"https://xprilion.com"}},"markdownRemark":{"id":"d0633760-fcec-5ae7-a79d-f1033b43b055","excerpt":"Cover art for Working with Amazon Keyspaces Cassandra distribution using Python Cassandra is a popular NoSQL database with capabilities to handle massive data…","html":"<p><img src=\"/images/covers/python-amazon-keyspaces-cassandra.png\" alt=\"Cover art for Working with Amazon Keyspaces Cassandra distribution using Python\"></p>\n<p><a href=\"https://cassandra.apache.org/doc/latest/\">Cassandra</a> is a popular NoSQL database with capabilities to handle massive data by using a distributed array of commodity hardware. After a boring introduction, here’s the fun part - Cassandra is a Facebook contribution to the world of Open Source, having been developed to handle the inbox search feature in Facebook almost a decade ago, and since it has been handed over to the <a href=\"https://www.apache.org/\">Apache Software Foundation</a>, it has been among the top open source projects under the organization.</p>\n<p>Cassandra powers the highly intensive queries in the applications of several major tech players - Instagram, Netflix, Facebook (before replacing it with HBase and further HBase with MyRocks), Twitter (before replacing it with in-house Manhattan), Walmart Labs, CERN, Cisco WebEx, and many more. You can read an extensive praise-o-logy of Cassandra on this <a href=\"https://ubuntu.com/blog/apache-cassandra-top-benefits\">Ubuntu blog titled What is Cassandra and why are big tech companies using it?</a></p>\n<p>While it can be a hassle to install and maintain a Cassandra database server online, <a href=\"https://aws.amazon.com/keyspaces/\">Amazon Keyspaces</a> offering by Amazon Web Services makes it a no-brainer to use. A similar powerful offering is provided by Datastax by the name <a href=\"https://www.datastax.com/products/datastax-astra\">Astra</a>. Both provide a managed service for Cassandra database which you can readily use both for development and production needs. Big plus - you can try both for free!</p>\n<p>In this tutorial, I shall be moving ahead with Amazon Keyspaces, considering the dearth of a complete example of how to use it on the Internet. You can very easily modify it to work with Datastax Astra.</p>\n<p>First off, before we make any queries, head over to the <a href=\"https://console.aws.amazon.com/keyspaces/home\">Amazon Keyspaces dashboard</a> and create a Keyspace and a sample Table using the Dashboard or the CQL Editor. Both actions being fairly simple, I shall leave it up to you to <a href=\"https://docs.aws.amazon.com/keyspaces/latest/devguide/getting-started.ddl.html\">explore how to get it done</a>. Let’s move ahead with how you can use them with a Python application.</p>\n<p>For convenience, I shall assume that the keyspace you created is named <code class=\"language-text\">test_keyspace</code> and the table is named <code class=\"language-text\">users</code>. The definition for <code class=\"language-text\">users</code> table is expected to be - </p>\n<table>\n<thead>\n<tr>\n<th align=\"center\">Column</th>\n<th align=\"center\">Type</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">id</td>\n<td align=\"center\">uuid</td>\n</tr>\n<tr>\n<td align=\"center\">name</td>\n<td align=\"center\">varchar</td>\n</tr>\n<tr>\n<td align=\"center\">age</td>\n<td align=\"center\">integer</td>\n</tr>\n<tr>\n<td align=\"center\">city</td>\n<td align=\"center\">varchar</td>\n</tr>\n</tbody>\n</table>\n<p>You’ll need to download a <a href=\"https://www.comodo.com/resources/small-business/digital-certificates.php\">Digital Certificate</a> provided by Amazon to be able to connect to Keyspaces since the service only connects through TLS. To do so, use the following command in a terminal window - </p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> https://www.amazontrust.com/repository/AmazonRootCA1.pem -O</code></pre></div>\n<br />\n<p>Create a new folder in your working directory named <code class=\"language-text\">.cassandra</code> and move the <code class=\"language-text\">AmazonRootCA1.pem</code> file there. Just cleaning up the working space, tbh, you can keep it wherever you wish, as long as its accessible to your Python script.</p>\n<p>Next, we shall need the <code class=\"language-text\">cassandra-driver</code> library for quick functionality to use Cassandra with Python. Run the following command to install it - </p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">pip <span class=\"token function\">install</span> cassandra-driver</code></pre></div>\n<br />\n<p>Now, we shall write a small barebones wrapper object for our connection with Amazon Keyspaces. Create a file called <code class=\"language-text\">db.py</code> in your working directory.</p>\n<p>Add the following code to make all necessary imports - </p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> cassandra<span class=\"token punctuation\">.</span>auth <span class=\"token keyword\">import</span> PlainTextAuthProvider\n<span class=\"token keyword\">from</span> cassandra<span class=\"token punctuation\">.</span>cluster <span class=\"token keyword\">import</span> Cluster\n<span class=\"token keyword\">from</span> ssl <span class=\"token keyword\">import</span> SSLContext<span class=\"token punctuation\">,</span> PROTOCOL_TLSv1_2<span class=\"token punctuation\">,</span> CERT_REQUIRED\n<span class=\"token keyword\">from</span> cassandra <span class=\"token keyword\">import</span> ConsistencyLevel\n<span class=\"token keyword\">from</span> cassandra<span class=\"token punctuation\">.</span>query <span class=\"token keyword\">import</span> SimpleStatement</code></pre></div>\n<br />\n<p>The above imports indicate a few things - </p>\n<ul>\n<li>\n<ol>\n<li>We’re going to be using the <code class=\"language-text\">PlainTextAuthProvider</code> which means at some point we’ll need a username and password combination for our connection with the database. We shall come around this.</li>\n</ol>\n</li>\n<li>\n<ol start=\"2\">\n<li><code class=\"language-text\">Cluster</code> indicates that we shall be creating an object of the Cassandra Cluster we connect to. This provides cluster level operations which can be useful for you, but not much in the course of this tutorial.</li>\n</ol>\n</li>\n<li>\n<ol start=\"3\">\n<li><code class=\"language-text\">SSLContext, PROTOCOL_TLSv1_2, CERT_REQUIRED</code> are all required for making a TLS connection to the Amazon Keyspaces service.</li>\n</ol>\n</li>\n<li>\n<ol start=\"4\">\n<li><code class=\"language-text\">ConsistencyLevel</code> if this is a bouncer, we shall get to overcoming it further down in this tutorial.</li>\n</ol>\n</li>\n<li>\n<ol start=\"5\">\n<li><code class=\"language-text\">SimpleStatement</code> is a simple CSQL statement, no wonders here. </li>\n</ol>\n</li>\n</ul>\n<p>Next, let’s begin using these imports.</p>\n<p>Create a class <code class=\"language-text\">Cassandra</code> and add an initialization constructor which creates and connection to the database service - </p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Cassandra</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        ssl_context <span class=\"token operator\">=</span> SSLContext<span class=\"token punctuation\">(</span>PROTOCOL_TLSv1_2<span class=\"token punctuation\">)</span>\n        ssl_context<span class=\"token punctuation\">.</span>load_verify_locations<span class=\"token punctuation\">(</span><span class=\"token string\">'.cassandra/AmazonRootCA1.pem'</span><span class=\"token punctuation\">)</span>\n        ssl_context<span class=\"token punctuation\">.</span>verify_mode <span class=\"token operator\">=</span> CERT_REQUIRED\n        auth_provider <span class=\"token operator\">=</span> PlainTextAuthProvider<span class=\"token punctuation\">(</span>\n            username<span class=\"token operator\">=</span><span class=\"token string\">'ServiceUsername'</span><span class=\"token punctuation\">,</span>\n            password<span class=\"token operator\">=</span><span class=\"token string\">'ServicePassword'</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>cluster <span class=\"token operator\">=</span> Cluster<span class=\"token punctuation\">(</span>\n            <span class=\"token punctuation\">[</span><span class=\"token string\">'cassandra.us-east-1.amazonaws.com'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n            ssl_context<span class=\"token operator\">=</span>ssl_context<span class=\"token punctuation\">,</span>\n            auth_provider<span class=\"token operator\">=</span>auth_provider<span class=\"token punctuation\">,</span>\n            port<span class=\"token operator\">=</span><span class=\"token number\">9142</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>session <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>cluster<span class=\"token punctuation\">.</span>connect<span class=\"token punctuation\">(</span><span class=\"token string\">\"test_keyspace\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n<br />\n<p>Notice <code class=\"language-text\">ServiceUsername</code> and <code class=\"language-text\">ServicePassword</code>, you do not yet have them. To create a pair of credentials to use, follow this instructions in <a href=\"https://docs.aws.amazon.com/keyspaces/latest/devguide/programmatic.credentials.html#programmatic.credentials.ssc\">this tutorial</a>.</p>\n<p>Your Cluster endpoint (<code class=\"language-text\">cassandra.us-east-1.amazonaws.com</code>) could differ from the one I have used in my example. You can find out your endpoint by visiting <a href=\"https://docs.aws.amazon.com/keyspaces/latest/devguide/programmatic.endpoints.html\">this list</a> and use the endpoint corresponding to your AWS Region.</p>\n<p>Now, let’s create a method for the <code class=\"language-text\">Cassandra</code> class that we can use to execute queries - </p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Cassandra</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">execute</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> query<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span>execute<span class=\"token punctuation\">(</span>SimpleStatement<span class=\"token punctuation\">(</span>\n                query<span class=\"token punctuation\">,</span> consistency_level<span class=\"token operator\">=</span>ConsistencyLevel<span class=\"token punctuation\">.</span>LOCAL_QUORUM<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<br />\n<p>Look, we used the <code class=\"language-text\">ConsistencyLevel</code> object here! What is this bird?</p>\n<p><img src=\"/images/2020/September/bird.jpg\" alt=\"What is this bird?\"></p>\n<p><strong>Consistency Level</strong> is the number of nodes which need to confirm that a particular write operation into a Cassandra database is successful. In simpler words, since Cassandra is a distributed database, and the data stored in Cassandra is split over multiple nodes, a single write operation is successful only when maximum possible nodes acknowledge the write operation as valid. For this, we use different consistency levels, some of which are - <code class=\"language-text\">LOCAL_ONE</code>, <code class=\"language-text\">LOCAL_QUORUM</code>, <code class=\"language-text\">ALL</code>, etc. You can read more about consistency levels in <a href=\"https://www.geeksforgeeks.org/consistency-levels-in-cassandra/\">this blog by Ashish Rana on GeeksforGeeks</a>.</p>\n<p>Currently, Amazon Keyspaces works only with the <code class=\"language-text\">LOCAL_QUORUM</code> consistency level.</p>\n<p>Now, we can delve into some action!</p>\n<p>Create a new file called <code class=\"language-text\">main.py</code> (or whatever fancy wording you can think of in 1 second), and put the following lines in it to try inserting a new entry to the database - </p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> db <span class=\"token keyword\">import</span> Cassandra\n\ncsql <span class=\"token operator\">=</span> Cassandra<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Insert Query</span>\nresults <span class=\"token operator\">=</span> csql<span class=\"token punctuation\">.</span>execute<span class=\"token punctuation\">(</span>\"INSERT INTO users <span class=\"token punctuation\">(</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> age<span class=\"token punctuation\">,</span> city<span class=\"token punctuation\">)</span> \\\n                        VALUES <span class=\"token punctuation\">(</span><span class=\"token number\">6ab09bec</span><span class=\"token operator\">-</span>e68e<span class=\"token operator\">-</span><span class=\"token number\">48d9</span><span class=\"token operator\">-</span>a5f8<span class=\"token operator\">-</span><span class=\"token number\">97e6fb4c9b47</span><span class=\"token punctuation\">,</span> \\\n                       <span class=\"token string\">'John'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">24</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Delhi'</span><span class=\"token punctuation\">)</span>\"<span class=\"token punctuation\">)</span></code></pre></div>\n<br />\n<p>Now, save the file and try executing it from the terminal using the following command - </p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">python main.py</code></pre></div>\n<br />\n<p>If the query is successful, you shall see no errors. </p>\n<p>Let’s try reading the database and see if we’ve got the entry right. Comment out the Insert query code in the <code class=\"language-text\">main.py</code> file and add the following lines - </p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># Read query</span>\nresults <span class=\"token operator\">=</span> csql<span class=\"token punctuation\">.</span>execute<span class=\"token punctuation\">(</span><span class=\"token string\">\"SELECT * FROM users\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>x <span class=\"token keyword\">for</span> x <span class=\"token keyword\">in</span> results<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></code></pre></div>\n<br />\n<p>You should see the output similar to this - </p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[Row(id=UUID(&#39;6ab09bec-e68e-48d9-a5f8-97e6fb4c9b47&#39;), city=&#39;Delhi&#39;, age=24, name=&#39;John&#39;)]</code></pre></div>\n<br />\n<p>If not, you need to observe the error message and try fixing the code! You can find the full code for this tutorial at - <a href=\"https://github.com/xprilion/python-amazon-keyspaces\">https://github.com/xprilion/python-amazon-keyspaces</a></p>\n<p>Cassandra can be a great tool if you’re looking to build highly scalable and mission-critical applications (given you need something like Cassandra, at all) and Amazon Keyspaces makes it very simple and efficient to use and manage.</p>\n<p>It is possible to use Amazon Keyspaces with other backends as well, and I shall leave it for you to explore them at your interest.</p>\n<p>Thanks for reading this!</p>","frontmatter":{"title":"Working with Amazon Keyspaces Cassandra distribution using Python","date":"September 17, 2020","comments":true,"nid":"100009"}}},"pageContext":{"slug":"/python-amazon-keyspaces-cassandra/","previous":{"fields":{"slug":"/generic-mongodb-wrapper-using-flask-pymongo/"},"frontmatter":{"title":"A Generic MongoDB Wrapper API with Flask and PyMongo"}},"next":{"fields":{"slug":"/decoding-propaganda-in-memes/"},"frontmatter":{"title":"Decoding Propaganda In Memes"}}}},"staticQueryHashes":["1296475691","3128451518"]}