{"componentChunkName":"component---src-templates-blog-post-js","path":"/docker-python-dump-http-request/","result":{"data":{"site":{"siteMetadata":{"title":"xprilion's blog","author":"Anubhav Singh","siteUrl":"https://xprilion.com"}},"markdownRemark":{"id":"50008a98-454b-5b4c-95aa-6319baca8372","excerpt":"This blog is an explanation for the code present in the github.com/xprilion/docker-python-dump-http-request-example repo. The main purpose of the repo is to…","html":"<p>This blog is an explanation for the code present in the <a href=\"https://github.com/xprilion/docker-python-dump-http-request-example\">github.com/xprilion/docker-python-dump-http-request-example</a> repo.</p>\n<p>The main purpose of the repo is to create a simple HTTP server developed using Python’s Flask framework, hosted in a Docker environment. The server is designed to log HTTP request and response data for debugging or informational purposes. The HTTP server receives requests, stores information about them, and then responds with a JSON representation of the request data.</p>\n<h2>Code Explanation</h2>\n<p>The repo contains the following files:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">root/\n├── .dockerignore\n├── Dockerfile\n├── main.py\n└── requirements.txt</code></pre></div>\n<p>Let’s go over these files in sequence of how they appear in the tree structure.</p>\n<h3><a href=\"https://github.com/xprilion/docker-python-dump-http-request-example/blob/main/.dockerignore\">.dockerignore</a></h3>\n<p>The <code class=\"language-text\">.dockerignore</code> file specifies a pattern for each file or directory that should be ignored when building a Docker image using a Dockerfile. Here’s what some lines in our <code class=\"language-text\">.dockerignore</code> file means:</p>\n<ol>\n<li><code class=\"language-text\">Dockerfile</code>: This line tells Docker to ignore the <code class=\"language-text\">Dockerfile</code> itself when building the Docker image. Although it might seem strange, this is a common practice. The <code class=\"language-text\">Dockerfile</code> is used to build the Docker image and is not usually required within the container itself.</li>\n<li><code class=\"language-text\">*.pyc, *.pyo, *.pyd</code>: These lines tell Docker to ignore Python compiled files. When Python programs run, they often create compiled versions of the Python source code. These files are not needed to run the Python program, as Python can run the source code directly.</li>\n<li><code class=\"language-text\">__pycache__</code>: This line tells Docker to ignore the <strong>pycache</strong> directory. When Python 3.2 and later versions run, they store compiled files in this directory. These files are not needed to run the Python program.</li>\n<li><code class=\"language-text\">.pytest_cache</code>: This line tells Docker to ignore the .pytest_cache directory. This directory is created when running tests with pytest, a testing framework for Python. It is not needed to run the Python application, and including it in the Docker image would increase the size of the image without providing any benefits.</li>\n</ol>\n<h3><a href=\"https://github.com/xprilion/docker-python-dump-http-request-example/blob/main/Dockerfile\">Dockerfile</a></h3>\n<p>This Dockerfile outlines the steps to create a Docker image for a Python application:</p>\n<ol>\n<li><code class=\"language-text\">FROM python:3.11-slim</code>: The base image is the official lightweight Python 3.11 image from Docker Hub.</li>\n<li><code class=\"language-text\">ENV PYTHONUNBUFFERED True</code>: Sets the environment variable <code class=\"language-text\">PYTHONUNBUFFERED</code> to <code class=\"language-text\">True</code> to allow log messages to be immediately displayed.</li>\n<li><code class=\"language-text\">ENV APP_HOME /app</code> and <code class=\"language-text\">WORKDIR $APP_HOME</code>: Sets <code class=\"language-text\">/app</code> as the working directory.</li>\n<li><code class=\"language-text\">COPY . ./</code>: Copies the local code into the Docker image.</li>\n<li><code class=\"language-text\">RUN pip install --no-cache-dir -r requirements.txt</code>: Installs the Python dependencies from <code class=\"language-text\">requirements.txt</code> file without storing the cache, for a smaller image.</li>\n<li><code class=\"language-text\">CMD exec gunicorn --bind :$PORT --workers 1 --threads 8 --timeout 0 main:app</code>: Specifies the command to run when the Docker container is started. The application is served using the Gunicorn HTTP server, binding to the environment variable <code class=\"language-text\">$PORT</code>, with one worker process and eight threads. The timeout is set to 0 to disable worker timeouts, leaving scaling management to the hosting platform (e.g., Google Cloud Run). The application instance is accessed via <code class=\"language-text\">main:app</code>, where <code class=\"language-text\">main</code> is the Python module (file) and <code class=\"language-text\">app</code> is the Flask application instance.</li>\n</ol>\n<h3><a href=\"https://github.com/xprilion/docker-python-dump-http-request-example/blob/main/main.py\">main.py</a></h3>\n<p>The <code class=\"language-text\">main.py</code> script is a Flask application that logs HTTP request and response data. Here’s what it does:</p>\n<ol>\n<li><strong>Initialization</strong>: A new Flask application is created and debugging is enabled.</li>\n<li><strong>Request Saving</strong>: The <code class=\"language-text\">save_request</code> function collects details from the incoming HTTP request, including endpoint, method, cookies, data, headers, arguments, form data, remote address, and file information, if any.</li>\n<li><strong>Response Saving</strong>: The <code class=\"language-text\">save_response</code> function collects details from the HTTP response, including status code, status message, headers, and response data.</li>\n<li><strong>Request and Response Logging</strong>: <code class=\"language-text\">before_request</code> logs the HTTP method and endpoint of each incoming request. <code class=\"language-text\">after_request</code> adds CORS headers to the response, logs the response data, and then returns the response.</li>\n<li><strong>Root Endpoint Handling</strong>: The <code class=\"language-text\">hello_world</code> function responds to HTTP GET requests at the root (<code class=\"language-text\">/</code>) endpoint. It generates a unique identifier for the request, saves the request data, creates a response containing the request data in JSON format, sets a cookie, and returns the response.</li>\n<li><strong>Server Launch</strong>: The server runs on all network interfaces (<code class=\"language-text\">0.0.0.0</code>) and listens on the port specified by the “PORT” environment variable, or 8080 if not set.</li>\n</ol>\n<h3><a href=\"https://github.com/xprilion/docker-python-dump-http-request-example/blob/main/requirements.txt\">requirements.txt</a></h3>\n<p>A <code class=\"language-text\">requirements.txt</code> file in a Python project is used to specify the dependencies of the project along with their  versions (optional). </p>\n<p>In this <code class=\"language-text\">requirements.txt</code> file, we load Flask and gunicorn, which are enough for us to build the project. In most real world projects there are far more dependencies and the <code class=\"language-text\">requirements.txt</code> file for such projects may span several dozen lines.</p>\n<p>When setting up the project, you can use <code class=\"language-text\">pip install -r requirements.txt</code> to install all of the dependencies. If version numbers are provided, pip will try to install the exact version numbers or else default to the latest available version.</p>\n<h2>Code Usage</h2>\n<p>Now, a quick note on how you can quickly deploy this code to anywhere you want using docker:</p>\n<ol>\n<li>\n<p><strong>Build the Docker image</strong>: Run the following command in the terminal, in the directory containing your Dockerfile. This command builds a Docker image with the tag <code class=\"language-text\">my-python-app</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> build <span class=\"token parameter variable\">-t</span> my-python-app <span class=\"token builtin class-name\">.</span></code></pre></div>\n</li>\n<li>\n<p><strong>Run the Docker container</strong>: Run the Docker container from the image you just created. Replace <code class=\"language-text\">$PORT</code> with the port number you want to use.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-p</span> <span class=\"token variable\">$PORT</span>:8080 <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">PORT</span><span class=\"token operator\">=</span><span class=\"token number\">8080</span> my-python-app</code></pre></div>\n<p>This command runs the Docker container, mapping the host’s <code class=\"language-text\">$PORT</code> to the container’s <code class=\"language-text\">8080</code> port, which the Flask application inside the Docker container is listening on.</p>\n</li>\n</ol>\n<p>Remember, you need to have Docker installed on your machine to execute these commands.</p>\n<p>In production scenarios, you would push your Docker image to a Docker registry (like Docker Hub, Google Container Registry, or AWS Elastic Container Registry), then pull and run the Docker image from machines where you want your application to run. Also, orchestration tools like Kubernetes, Docker Swarm, or managed services like Google Cloud Run, AWS ECS/Fargate could be used to handle deployment, scaling, and management of Docker containers in a production setting.</p>\n<p>When you hit the endpoint created by deploying this code, you’ll get a response similar to the one below:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"uuid\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"f50cc7d0f26511eda4bb75c989e55f1e\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"endpoint\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"hello_world\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"method\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"GET\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"cookies\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"cookie-name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"cookie-value\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"data\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"b''\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"headers\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"Host\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"test-cloud-run-custom.xpri.dev\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Cache-Control\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"max-age=0\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Sec-Ch-Ua\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\\\"Chromium\\\";v=\\\"112\\\", \\\"Google Chrome\\\";v=\\\"112\\\", \\\"Not:A-Brand\\\";v=\\\"99\\\"\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Sec-Ch-Ua-Mobile\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"?0\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Sec-Ch-Ua-Platform\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\\\"macOS\\\"\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Upgrade-Insecure-Requests\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"User-Agent\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Safari/537.36\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Accept\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Sec-Ch-Ua-Arch\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\\\"arm\\\"\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Sec-Ch-Ua-Platform-Version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\\\"13.3.1\\\"\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Sec-Ch-Ua-Model\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\\\"\\\"\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Sec-Ch-Ua-Bitness\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\\\"64\\\"\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Sec-Ch-Ua-Wow64\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"?0\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Sec-Ch-Ua-Full-Version-List\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\\\"Chromium\\\";v=\\\"112.0.5615.137\\\", \\\"Google Chrome\\\";v=\\\"112.0.5615.137\\\", \\\"Not:A-Brand\\\";v=\\\"99.0.0.0\\\"\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Sec-Fetch-Site\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"none\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Sec-Fetch-Mode\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"navigate\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Sec-Fetch-User\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"?1\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Sec-Fetch-Dest\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"document\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Accept-Language\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"en-US,en;q=0.9\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"X-Cloud-Trace-Context\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"7361fa590088de543df325a9832ab85e/4131215564459013469\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Traceparent\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"00-7361fa590088de543df325a9832ab85e-395506aaf224f55d-00\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"X-Forwarded-For\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2401:4900:xxxx:xxxx:xxxx:5400:xxxx:xxxx\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"X-Forwarded-Proto\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Forwarded\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"for=\\\"[2401:4900:xxxx:xxxx:xxxx:5400:xxxx:xxxx]\\\";proto=https\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Accept-Encoding\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"gzip, deflate, br\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"args\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"form\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"remote_addr\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"169.xxx.xxx.xxx\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"files\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This response is a JSON representation of the details of an HTTP GET request received by the server. Let’s break down what each key-value pair means:</p>\n<p>“uuid”: “f50cc7d0f26511eda4bb75c989e55f1e”: This is a unique identifier for this request. It will change every time.</p>\n<p>“endpoint”: “hello_world”: The name of the endpoint that was hit. It corresponds to the function handling the request in the Flask application.</p>\n<p>“method”: “GET”: The HTTP method used for this request.</p>\n<p>“cookies”: {“cookie-name”: “cookie-value”}: The cookies sent with this request. In this case, there is one cookie named “cookie-name” with a value of “cookie-value”.</p>\n<p>“data”: “b””: The data sent with this request. In this case, no data was sent.</p>\n<p>“headers”: This is a dictionary containing all the HTTP headers that were sent with the request. This includes information about the client, the accepted response types, and more.</p>\n<p>“args”: {} and “form”: {}: These would contain any query parameters or form data sent with the request. In this case, none were sent.</p>\n<p>“remote_addr”: “169.xxx.xxx.xxx”: This is the IP address of the client that sent the request.</p>\n<p>“files”: []: This would contain any files sent with the request. In this case, none were sent.</p>","frontmatter":{"title":"Docker Python Dump HTTP Request Example","date":"May 13, 2023","comments":true,"nid":"130520231708"}}},"pageContext":{"slug":"/docker-python-dump-http-request/","previous":{"fields":{"slug":"/job-scheduling-on-google-cloud-platform/"},"frontmatter":{"title":"Job Scheduling on Google Cloud Platform"}},"next":{"fields":{"slug":"/talks/"},"frontmatter":{"title":"Talks"}}}},"staticQueryHashes":["1296475691","3128451518"]}